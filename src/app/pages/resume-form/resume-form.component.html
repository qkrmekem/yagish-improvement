<div class="resume-form-container">
  <!-- 헤더 영역 -->
  <div class="header-controls">
    <div class="header-left">
      <a mat-icon-button routerLink="/resume-select" [queryParams]="{type: resumeType()}" class="back-btn">
        <mat-icon>arrow_back</mat-icon>
      </a>
      <div class="title-group">
        <h1>{{ resumeTypeName() }}</h1>
        <span class="subtitle">{{ 'RESUME.TITLE' | translate }}</span>
      </div>
    </div>
    <div class="header-actions">
      <button mat-raised-button color="primary" class="preview-btn" (click)="openPreview()">
        <mat-icon>preview</mat-icon>
        {{ 'COMMON.PREVIEW' | translate }}
      </button>
    </div>
  </div>

  <!-- 개선점 4: 입력폼 / 미리보기 탭 -->
  <div class="improvement-badge">
    <span class="badge">{{ 'IMPROVEMENT.BADGE' | translate }} 4</span> {{ 'IMPROVEMENT.TABS' | translate }}
  </div>

  <mat-tab-group animationDuration="200ms" class="form-tabs">
    <!-- 입력폼 탭 -->
    <mat-tab [label]="'TABS.INPUT' | translate">
      <div class="tab-content">

        <!-- 개선점 3: 세로 스텝퍼 (데스크탑) / 가로 스텝퍼 (모바일) -->
        <div class="improvement-badge">
          <span class="badge">{{ 'IMPROVEMENT.BADGE' | translate }} 3</span> {{ 'IMPROVEMENT.STEPPER' | translate }}
        </div>

        <div class="stepper-layout" [class.vertical]="isVerticalStepper()" [class.horizontal]="!isVerticalStepper()">
          <!-- 스텝퍼 네비게이션 -->
          <nav class="stepper-nav">
            <button
              *ngFor="let step of steps; let i = index"
              class="step-button"
              [class.active]="currentStep() === i"
              [class.completed]="currentStep() > i"
              (click)="goToStep(i)">
              <span class="step-icon">
                <mat-icon *ngIf="currentStep() > i">check</mat-icon>
                <mat-icon *ngIf="currentStep() <= i">{{ step.icon }}</mat-icon>
              </span>
              <span class="step-label">{{ 'STEPS.' + step.labelKey | translate }}</span>
              <span class="step-number">{{ i + 1 }} / {{ steps.length }}</span>
            </button>
          </nav>

          <!-- 동적 컴포넌트 컨테이너 -->
          <div class="step-content">
            <ng-container #stepContainer></ng-container>
          </div>
        </div>
      </div>
    </mat-tab>

    <!-- 미리보기 탭 -->
    <mat-tab [label]="'TABS.PREVIEW' | translate">
      <div class="tab-content preview-tab">
        
        <!-- PDF 생성용 wrapper -->
        <div #resumePreviewWrapper class="resume-preview-wrapper">
          <!-- 기존 한국식 템플릿 (standard, original, career) -->
          <div class="resume-preview" *ngIf="resumeType() !== 'free-form'">
            <div class="preview-header">
              <h2>{{ 'RESUME.TITLE' | translate }}</h2>
              <p class="date-display">{{ 'RESUME.WRITE_DATE' | translate }}: {{ formatDate(basicInfoForm.get('resumeDate')?.value) }}</p>
            </div>

            <section class="preview-section">
              <h3>{{ 'STEPS.BASIC_INFO' | translate }}</h3>
              <mat-divider></mat-divider>
            <div class="info-grid">
              <div class="info-item">
                <label>{{ 'BASIC_INFO.NAME' | translate }}</label>
                <span>{{ basicInfoForm.get('name')?.value || ('COMMON.NOT_ENTERED' | translate) }}</span>
              </div>
              <div class="info-item">
                <label>{{ 'BASIC_INFO.EMAIL' | translate }}</label>
                <span>{{ basicInfoForm.get('email')?.value || ('COMMON.NOT_ENTERED' | translate) }}</span>
              </div>
              <div class="info-item">
                <label>{{ 'BASIC_INFO.PHONE' | translate }}</label>
                <span>{{ basicInfoForm.get('phone')?.value || ('COMMON.NOT_ENTERED' | translate) }}</span>
              </div>
              <div class="info-item">
                <label>{{ 'BASIC_INFO.BIRTH_DATE' | translate }}</label>
                <span>{{ formatDate(basicInfoForm.get('birthDate')?.value) || ('COMMON.NOT_ENTERED' | translate) }}</span>
              </div>
            </div>
          </section>

          <section class="preview-section">
            <h3>{{ 'STEPS.EDUCATION' | translate }}</h3>
            <mat-divider></mat-divider>
            <div class="preview-item" *ngFor="let school of schools.controls">
              <strong>{{ school.get('schoolName')?.value || ('EDUCATION.SCHOOL_NAME' | translate) }}</strong>
              <span class="detail">{{ school.get('major')?.value }} ({{ school.get('status')?.value }})</span>
            </div>
          </section>

          <section class="preview-section">
            <h3>{{ 'STEPS.CAREER' | translate }}</h3>
            <mat-divider></mat-divider>
            <div class="preview-item" *ngFor="let career of careers.controls">
              <strong>{{ career.get('companyName')?.value || ('CAREER.COMPANY_NAME' | translate) }}</strong>
              <span class="detail">{{ career.get('position')?.value }}</span>
              <p class="description">{{ career.get('description')?.value }}</p>
            </div>
          </section>

          <section class="preview-section">
            <h3>{{ 'CERTIFICATIONS.TITLE' | translate }}</h3>
            <mat-divider></mat-divider>
            <div class="preview-item" *ngFor="let cert of certifications.controls">
              <strong>{{ cert.get('certName')?.value || ('CERTIFICATIONS.CERT_NAME' | translate) }}</strong>
              <span class="detail">{{ cert.get('issuer')?.value }}</span>
            </div>
          </section>

          <section class="preview-section">
            <h3>{{ 'LANGUAGE_SKILLS.TITLE' | translate }}</h3>
            <mat-divider></mat-divider>
            <div class="preview-item" *ngFor="let lang of languageSkills.controls">
              <strong>{{ lang.get('language')?.value }} - {{ lang.get('examName')?.value }}</strong>
              <span class="detail">{{ 'LANGUAGE_SKILLS.GRADE' | translate }}: {{ lang.get('grade')?.value }} | {{ 'LANGUAGE_SKILLS.SCORE' | translate }}: {{ lang.get('score')?.value }}</span>
            </div>
          </section>

          <section class="preview-section">
            <h3>{{ 'STEPS.SELF_INTRO' | translate }}</h3>
            <mat-divider></mat-divider>
            <div class="text-content">
              <h4>{{ 'SELF_INTRO.MOTIVATION' | translate }}</h4>
              <p>{{ selfIntroForm.get('motivation')?.value || ('COMMON.NOT_ENTERED' | translate) }}</p>
              <h4>{{ 'SELF_INTRO.STRENGTHS' | translate }}</h4>
              <p>{{ selfIntroForm.get('strengths')?.value || ('COMMON.NOT_ENTERED' | translate) }}</p>
            </div>
          </section>
        </div>

        <!-- 자유양식 (US 스타일 Resume) -->
        <div class="resume-preview free-form-preview" *ngIf="resumeType() === 'free-form'">
          <!-- 헤더: 이름, 직함, 연락처 (사진 없음, 중앙 정렬) -->
          <div class="free-form-header">
            <h1 class="free-form-name">{{ basicInfoForm.get('name')?.value || 'Your Name' }}</h1>
            <p class="free-form-title">{{ careers.length > 0 && careers.controls[0].get('position')?.value ? careers.controls[0].get('position')?.value : 'Professional Title' }}</p>
            <p class="free-form-contact">
              {{ basicInfoForm.get('email')?.value || 'email@example.com' }} 
              <span class="separator">|</span> 
              {{ basicInfoForm.get('phone')?.value || '+82-10-0000-0000' }}
              <ng-container *ngIf="basicInfoForm.get('address')?.value">
                <span class="separator">|</span> 
                {{ basicInfoForm.get('address')?.value }}
              </ng-container>
            </p>
          </div>

          <hr class="free-form-divider">

          <!-- SUMMARY -->
          <section class="free-form-section" *ngIf="selfIntroForm.get('motivation')?.value">
            <h2 class="free-form-section-title">SUMMARY</h2>
            <p class="free-form-content">{{ selfIntroForm.get('motivation')?.value }}</p>
          </section>

          <!-- STRENGTHS (장점/특기) -->
          <section class="free-form-section" *ngIf="selfIntroForm.get('strengths')?.value">
            <h2 class="free-form-section-title">STRENGTHS</h2>
            <p class="free-form-content">{{ selfIntroForm.get('strengths')?.value }}</p>
          </section>

          <!-- EXPERIENCE -->
          <section class="free-form-section" *ngIf="careers.length > 0 && careers.controls[0].get('companyName')?.value">
            <h2 class="free-form-section-title">EXPERIENCE</h2>
            <div class="free-form-item" *ngFor="let career of careers.controls">
              <div class="free-form-item-header">
                <strong>{{ career.get('companyName')?.value || 'Company Name' }}</strong>
                <span class="free-form-date">{{ formatDate(career.get('startDate')?.value) }} - {{ career.get('isCurrent')?.value ? 'Present' : formatDate(career.get('endDate')?.value) }}</span>
              </div>
              <p class="free-form-item-title">{{ career.get('position')?.value || 'Position' }}</p>
              <p class="free-form-item-description" *ngIf="career.get('description')?.value">{{ career.get('description')?.value }}</p>
            </div>
          </section>

          <!-- EDUCATION -->
          <section class="free-form-section" *ngIf="schools.length > 0 && schools.controls[0].get('schoolName')?.value">
            <h2 class="free-form-section-title">EDUCATION</h2>
            <div class="free-form-item" *ngFor="let school of schools.controls">
              <div class="free-form-item-header">
                <strong>{{ school.get('schoolName')?.value || 'School Name' }}</strong>
                <span class="free-form-date">{{ school.get('status')?.value }}</span>
              </div>
              <p class="free-form-item-title" *ngIf="school.get('major')?.value">{{ school.get('major')?.value }}</p>
            </div>
          </section>

          <!-- SKILLS & CERTIFICATIONS -->
          <section class="free-form-section" *ngIf="(certifications.length > 0 && certifications.controls[0].get('certName')?.value) || (languageSkills.length > 0 && languageSkills.controls[0].get('language')?.value)">
            <h2 class="free-form-section-title">SKILLS & CERTIFICATIONS</h2>
            <ul class="free-form-skills-list">
              <ng-container *ngFor="let cert of certifications.controls">
                <li *ngIf="cert.get('certName')?.value">
                  {{ cert.get('certName')?.value }} <span class="free-form-issuer" *ngIf="cert.get('issuer')?.value">- {{ cert.get('issuer')?.value }}</span>
                </li>
              </ng-container>
              <ng-container *ngFor="let lang of languageSkills.controls">
                <li *ngIf="lang.get('language')?.value">
                  {{ lang.get('language')?.value }}: {{ lang.get('examName')?.value }} {{ lang.get('score')?.value ? '(' + lang.get('score')?.value + ')' : '' }}
                </li>
              </ng-container>
            </ul>
          </section>

          <!-- HOBBIES & INTERESTS -->
          <section class="free-form-section" *ngIf="selfIntroForm.get('hobbies')?.value">
            <h2 class="free-form-section-title">HOBBIES & INTERESTS</h2>
            <p class="free-form-content">{{ selfIntroForm.get('hobbies')?.value }}</p>
          </section>
        </div>
        </div><!-- /resume-preview-wrapper -->

        <div class="preview-actions">
          <button mat-raised-button color="primary" (click)="openPreview()">
            <mat-icon>fullscreen</mat-icon> {{ 'COMMON.PREVIEW' | translate }}
          </button>
          <button mat-raised-button color="accent" (click)="downloadPdf()">
            <mat-icon>picture_as_pdf</mat-icon> PDF
          </button>
        </div>
      </div>
    </mat-tab>
  </mat-tab-group>
</div>
